import React from 'react';

import { Modal, Button } from 'react-bootstrap';

import {
    Redirect
} from 'react-router-dom';

import {
    currentLanguage
} from 'storages';

import {
    getUrlParameter
} from 'utils';

import {
    AccountActivationService
} from 'services';

import {
    AccountActivationRequestDetail
} from 'models';

import {
    Onboarding,
    Registration,
    SakukuPIN,
    Verification,
} from './components';

import {
    Loader
} from 'shared/components';

import AccountActivationError from './account-activation-error';

enum AccountActivationSteps {
    Onboarding,
    Verification,
    RegisterOrPIN,
    Success,
}

//#region Reducer
enum StateStatus {
    LOADING,
    RESOLVED,
    REJECTED
}

type ErrorState = {
    isFatalError: boolean;
    content: string;
}

type State = {
    isLoading: boolean,
    requestData?: AccountActivationRequestDetail,
    error?: ErrorState
};

type Action =
    { type: StateStatus.LOADING } |
    { type: StateStatus.RESOLVED, requestData: AccountActivationRequestDetail } |
    { type: StateStatus.REJECTED, data: ErrorState };

function reducer(state: State, action: Action): State {
    switch (action.type) {
        case StateStatus.LOADING:
            return { isLoading: true };
        case StateStatus.RESOLVED:
            return { isLoading: false, requestData: action.requestData };
        case StateStatus.REJECTED:
            return { isLoading: false, error: action.data };
        default:
            throw new Error(`Unhandled type`);
    }
}
//#endregion

const AccountActivation: React.FC =
    () => {
        const requestId = getUrlParameter('req-id') || '';
        const [{ isLoading, requestData, error }, dispatch] = React.useReducer(reducer, {
            isLoading: false
        });

        const requestCountdownTimerRef = React.useRef(0);

        const [currentStep, setCurrentStep] = React.useState(0);

        const [verificationData, setVerificationData] = React.useState<{ birth_date: string, is_registered: boolean, phone_number: string } | undefined>();

        const [errorModal, setErrorModal] = React.useState<any>();

        //#region Wizard Stepper
        const toNextStep = () => {
            if (currentStep + 1 === AccountActivationSteps.Success) {
                clearInterval(requestCountdownTimerRef.current);
            }
            setCurrentStep(step => step + 1);
        };

        /**
         * Go to previous step. If it was already the first step, consider it as cancel registration.
         */
        // const toPreviousStep = () => {
        //     if (currentStep === 0) {
        //         // setError({
        //         //     isRecoverable: false,
        //         //     content: 'Proses dibatalkan'
        //         // });
        //     }
        //     setCurrentStep(step => step - 1);
        // };
        //#endregion

        //#region Error Modal
        // populate error content
        const handleErrorModal = React.useCallback(({
            isFatalError = false,
            content,
            onClose
        }: {
            isFatalError: boolean,
            content: string,
            onClose?: Function
        }) => {
            if (isFatalError === true) {
                clearInterval(requestCountdownTimerRef.current);

                dispatch({
                    type: StateStatus.REJECTED,
                    data: { isFatalError, content }
                });

                return;
            }

            setErrorModal({
                children: content,
                onClose: () => {
                    setErrorModal(null);

                    if (onClose) {
                        onClose();
                    }
                }
            });
        }, []);
        //#endregion

        //#region Get Request Detail
        React.useEffect(() => {
            const getRequestDetail = async (requestId: string) => {
                try {
                    dispatch({
                        type: StateStatus.LOADING
                    });

                    const { output_schema } = await AccountActivationService.getRequestDetail(requestId);

                    dispatch({
                        type: StateStatus.RESOLVED,
                        requestData: output_schema
                    });

                    let timeLeft = output_schema.remaining_time || 0;

                    requestCountdownTimerRef.current = window.setInterval(() => {
                        timeLeft--;

                        // console.log(`Request will expired in: ${timeLeft}s`);

                        if (timeLeft === 0) {
                            dispatch({
                                type: StateStatus.REJECTED,
                                data: {
                                    isFatalError: true,
                                    content: 'Waktu telah habis. Silakan ulangi kembali'
                                }
                            });
                        }
                    }, 1000);
                } catch (error) {
                    const {
                        data: { error_schema }
                    } = error;

                    dispatch({
                        type: StateStatus.REJECTED,
                        data: {
                            isFatalError: error_schema.fatal_error_flag === true,
                            content: error_schema.message
                        }
                    });
                }

            };

            getRequestDetail(requestId);
        }, [requestId]);
        //#endregion

        const handleSubmitVerification = (
            data: {
                birth_date: string,
                is_registered: boolean,
                phone_number: string
            }
        ) => {
            setVerificationData({
                birth_date: data.birth_date,
                is_registered: data.is_registered,
                phone_number: data.phone_number
            });
            toNextStep();
        };

        const handleSubmitSakukuPIN = () => {
            toNextStep();
        };

        const handleSubmitRegistration = () => {
            toNextStep();
        };

        if (error) {
            if (error.isFatalError === true) {
                clearInterval(requestCountdownTimerRef.current);

                return <Redirect to={{
                    pathname: `/${currentLanguage.get()}/account-activation/error`,
                    state: {
                        isFatal: true,
                        content: error.content
                    }
                }} />
            }

            return (
                <AccountActivationError
                    isFatal={error.isFatalError}
                    content={error.content}>
                </AccountActivationError>
            );
        }

        return (<>
            {errorModal &&
                <Modal show={true}
                    centered={true}>
                    <Modal.Body className="text-center">
                        {errorModal.children}
                    </Modal.Body>
                    <Modal.Footer>
                        <Button
                            type="button"
                            block={true}
                            onClick={errorModal?.onClose}>
                            Tutup
                        </Button>
                    </Modal.Footer>
                </Modal>
            }

            {isLoading && <Loader type="absolute" />}

            {requestData && <>
                {currentStep === AccountActivationSteps.Onboarding &&
                    <Onboarding
                        merchantName={requestData.merchant_name}
                        onNext={toNextStep}
                    />
                }
                {currentStep === AccountActivationSteps.Verification &&
                    <Verification
                        requestId={requestId}
                        phoneNumber={requestData.phone_number}
                        onError={handleErrorModal}
                        onSubmit={handleSubmitVerification}
                    />
                }
                {currentStep === AccountActivationSteps.RegisterOrPIN && <>
                    {verificationData && verificationData.is_registered === true
                        && <SakukuPIN
                            requestId={requestId}
                            birthDate={verificationData.birth_date}
                            onError={handleErrorModal}
                            onSubmit={handleSubmitSakukuPIN} />
                    }
                    {verificationData && verificationData.is_registered === false
                        && <Registration
                            requestId={requestId}
                            // verificationData={verificationData}
                            birthDate={verificationData.birth_date}
                            onError={handleErrorModal}
                            onSubmit={handleSubmitRegistration} />
                    }
                </>}
                {currentStep === AccountActivationSteps.Success &&
                    <Redirect
                        to={{
                            pathname: `/${currentLanguage.get()}/account-activation/success`,
                            state: {
                                merchantName: requestData.merchant_name,
                                phoneNumber: requestData.phone_number
                            }
                        }} />
                }
            </>}
        </>);
    };

export default AccountActivation;